<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Real Estate Market Analysis</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/2.0.5/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/select/2.0.0/css/select.bootstrap5.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/2.0.5/js/dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/2.0.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #6c757d;
            --success-color: #2ecc71;
            --info-color: #3498db;
            --warning-color: #f39c12;
            --accent-color: #7209b7;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-color: #333333;
            --light-text: #6c757d;
            --table-header-bg: #4361ee;
            --table-header-color: #ffffff;
            --table-row-hover: rgba(67, 97, 238, 0.1);
            --table-stripe: rgba(67, 97, 238, 0.05);
            --border-radius: 12px;
            --box-shadow: 0 6px 18px rgba(0,0,0,0.1);
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 0;
            margin: 0;
        }
        
        .header {
            background: linear-gradient(135deg, #006E3F, #000000);
            color: white;
            padding: 2.5rem 0;
            margin-bottom: 2rem;
            text-align: center;
            box-shadow: var(--box-shadow);
        }
        
        .header h1 {
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .header p {
            opacity: 0.9;
            max-width: 700px;
            margin: 0 auto;
        }
        
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem 2rem;
        }
        
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            border: none;
            margin-bottom: 2rem;
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background: var(--card-bg);
            border-bottom: 1px solid rgba(0,0,0,0.1);
            padding: 1.25rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .card-header h2 {
            font-weight: 600;
            font-size: 1.25rem;
            margin: 0;
            color: var(--primary-color);
        }
        
        .card-header .card-icon {
            background: var(--primary-color);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        
        .card-body {
            padding: 1.25rem;
        }
        
        .filter-section {
            margin-bottom: 1rem;
        }
        
        .filter-toggle {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.4rem 1rem;
            border-radius: 5px;
            margin-bottom: 0.5rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .filter-toggle:hover {
            background: #3651d1;
        }
        
        .filter-group {
            gap: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        .filter-item {
            flex: 1 1 180px;
        }
        
        .filter-label {
            font-weight: 500;
            color: var(--secondary-color);
            font-size: 0.875rem;
            margin-bottom: 0.3rem;
        }
        
        .filter-input, select.filter-input {
            padding: 0.25rem 0.4rem;
            font-size: 0.85rem;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 5px;
            width: 100%;
            background-color: white;
        }
        
        .filter-input:focus, select.filter-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
        }
        
        /* Custom styling for select elements */
        select.filter-input {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='rgba(0, 0, 0, 0.5)' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.7rem center;
            background-size: 1rem;
            padding-right: 2rem;
        }
        
        /* Styling for multi-select dropdowns */
        select.filter-input[multiple] {
            height: auto;
            min-height: 120px;
            background-image: none;
            padding-right: 0.5rem;
        }
        
        /* Styling for checkbox container */
        .checkbox-container {
            max-height: 200px;
            overflow-y: auto;
            padding: 0.5rem;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 5px;
            background-color: white;
        }
        
        /* Styling for form-check */
        .form-check {
            padding-left: 1.8rem;
            margin-bottom: 0.5rem;
            position: relative;
        }
        
        .form-check-input {
            position: absolute;
            margin-top: 0.25rem;
            margin-left: -1.5rem;
        }
        
        .form-check-label {
            font-size: 0.9rem;
            margin-bottom: 0;
        }
        
        /* Styling for select controls */
        .select-controls {
            margin-top: 0.5rem;
        }
        
        .select-controls button {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }
        
        .btn-outline-primary {
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }
        
        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-outline-secondary {
            color: var(--secondary-color);
            border: 1px solid var(--secondary-color);
        }
        
        .btn-outline-secondary:hover {
            background-color: var(--secondary-color);
            color: white;
        }
        
        /* Range inputs styling */
        .form-control {
            display: block;
            width: 100%;
            padding: 0.375rem 0.75rem;
            font-size: 0.9rem;
            line-height: 1.5;
            color: var(--text-color);
            background-color: #fff;
            background-clip: padding-box;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 5px;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            outline: 0;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
        }
        
        .d-flex {
            display: flex;
        }
        
        .gap-2 {
            gap: 0.5rem;
        }
        
        .mt-1 {
            margin-top: 0.25rem;
        }
        
        .justify-content-between {
            justify-content: space-between;
        }
        
        .filter-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 0.5rem;
        }
        
        .btn-reset {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 0.4rem 1rem;
            border-radius: 5px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-reset:hover {
            background: #5a6268;
        }
        
        /* Table styling */
        table.dataTable {
            border-radius: 8px;
            overflow: hidden;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.85rem;
        }
        
        table.dataTable thead th {
            background-color: var(--table-header-bg);
            color: var(--table-header-color);
            font-weight: 600;
            padding: 0.75rem 0.5rem;
            border: none;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            border-bottom: none;
            vertical-align: middle;
            position: relative;
            z-index: 1;
            text-shadow: 0px 0px 1px rgba(0,0,0,0.2);
        }
        
        /* Specific styling to ensure header text is visible */
        .table-striped > thead > tr {
            background-color: var(--table-header-bg) !important;
        }
        
        .table-striped > thead > tr > th {
            color: white !important;
            background-color: var(--table-header-bg) !important;
            font-weight: 600 !important;
        }
        
        table.dataTable tbody tr {
            background-color: var(--card-bg);
            transition: all 0.3s ease;
        }
        
        table.dataTable.table-striped>tbody>tr:nth-of-type(odd) {
            background-color: var(--table-stripe);
        }
        
        table.dataTable tbody tr:hover {
            background-color: var(--table-row-hover);
        }
        
        table.dataTable tbody td {
            padding: 0.5rem 0.5rem;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            vertical-align: middle;
        }
        
        .table-stats {
            background: var(--primary-color);
            color: white;
            border-radius: 8px;
            padding: 0.75rem;
            display: flex;
            justify-content: space-around;
            margin-bottom: 1rem;
            box-shadow: var(--box-shadow);
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.15rem;
        }
        
        .stat-label {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        .price-cell {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 0.85rem;
        }
        
        .charts-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            margin-top: 2rem;
            margin-bottom: 1rem;
        }
        
        .chart-card {
            flex: 1 1 400px;
            min-height: 300px;
        }
        
        @media (max-width: 992px) {
            .dashboard-container {
                padding: 0 1rem 1rem;
            }
            
            .header {
                padding: 2rem 0;
            }
            
            .filter-item {
                flex: 1 1 100%;
            }
        }
        
        @media (max-width: 768px) {
            .table-responsive {
                overflow-x: auto;
            }
            
            .stat-value {
                font-size: 1.2rem;
            }
            
            .header h1 {
                font-size: 1.75rem;
            }
        }
        
        /* Add this at the end of the style section to override any conflicting styles */
        #salesTable thead th {
            background-color: #4361ee !important;
            color: #ffffff !important;
            font-weight: 600 !important;
        }
        
        .range-group {
            padding: 0.5rem;
            border: 1px solid rgba(67, 97, 238, 0.1);
            border-radius: 5px;
            background-color: rgba(67, 97, 238, 0.05);
            margin-bottom: 0.5rem;
        }
        
        .range-group .filter-label {
            font-weight: 500;
            color: var(--secondary-color);
            font-size: 0.875rem;
            margin-bottom: 0.3rem;
        }
        
        /* Making filter range inputs narrower */
        .range-group .form-control {
            font-size: 0.85rem;
            padding: 0.25rem 0.5rem;
        }
        
        /* Make the DataTable more compact */
        div.dataTables_wrapper div.dataTables_info {
            font-size: 0.8rem;
            padding-top: 0.5rem;
        }
        
        div.dataTables_wrapper div.dataTables_paginate {
            font-size: 0.8rem;
            padding-top: 0.25rem;
        }
        
        div.dataTables_wrapper div.dataTables_length label,
        div.dataTables_wrapper div.dataTables_filter label {
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }
        
        div.dataTables_wrapper div.dataTables_length select {
            width: auto;
            padding: 0.25rem 0.5rem;
            font-size: 0.85rem;
        }
        
        div.dataTables_wrapper div.dataTables_filter input {
            padding: 0.25rem 0.5rem;
            font-size: 0.85rem;
        }
        
        .paginate_button {
            padding: 0.25rem 0.5rem !important;
        }
        
        /* Reduce spacing in filter section */
        .filter-section {
            margin-bottom: 1rem;
        }
        
        .filter-wrapper {
            margin-bottom: 0.5rem;
        }
        
        .filter-group {
            gap: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        .filter-item {
            flex: 1 1 180px;
        }
        
        /* Compress the stats display */
        .table-stats {
            padding: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .stat-value {
            font-size: 1.25rem;
            margin-bottom: 0.15rem;
        }
        
        .stat-label {
            font-size: 0.8rem;
        }
        
        /* Reduce space below filter toggle button */
        .filter-toggle {
            margin-bottom: 0.5rem;
            padding: 0.4rem 1rem;
            font-size: 0.9rem;
        }
        
        /* Style for address links */
        .address-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .address-link:hover {
            text-decoration: underline;
            color: var(--accent-color);
        }
        
        /* Styles for map and realtor icons */
        .address-actions {
            margin-left: 8px;
            white-space: nowrap;
        }
        
        .map-icon, .realtor-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            text-align: center;
            margin-left: 4px;
            text-decoration: none;
            transition: all 0.2s ease;
        }
        
        .map-icon {
            background-color: #ea4335; /* Google red */
            color: white;
        }
        
        .realtor-icon {
            background-color: #0077e5; /* Realtor blue */
            color: white;
        }
        
        .map-icon:hover, .realtor-icon:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .map-icon i, .realtor-icon i {
            font-size: 12px;
        }
        
        /* Assessor link styling */
        .assessor-link {
            display: inline-block;
            margin-top: 15px;
            color: white;
            background-color: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 5px;
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .assessor-link:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            color: white;
        }
    </style>
</head>
<body>

<div class="header">
    <div class="container">
        <h1>East Greenbush Home Sales</h1>
        <p>2022-2024</p>
        <a href="https://eastgreenbush.org/departments/assessor/2025_town_wide_systematic_review.php" target="_blank" class="assessor-link">Link to Assessor Review and Grievance Page</a>
    </div>
</div>

<div class="dashboard-container">
    <!-- Stats Section -->
    <div class="table-stats">
        <div class="stat-item">
            <div class="stat-value" id="rowCount">0</div>
            <div class="stat-label">Properties</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="avgPrice">0</div>
            <div class="stat-label">Avg. Sale Price</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="avgSqft">0</div>
            <div class="stat-label">Avg. Square Footage</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="avgPricePerSqft">0</div>
            <div class="stat-label">Avg. Price/SqFt</div>
        </div>
    </div>
    
    <!-- Charts Section -->
    <div class="charts-row">
        <div class="card chart-card">
            <div class="card-header">
                <h2>Price Distribution by Property Style</h2>
                <div class="card-icon">
                    <i class="fas fa-chart-bar"></i>
                </div>
            </div>
            <div class="card-body">
                <canvas id="styleChart"></canvas>
            </div>
        </div>
        
        <div class="card chart-card">
            <div class="card-header">
                <h2>Price per SqFt by Year Built</h2>
                <div class="card-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
            </div>
            <div class="card-body">
                <canvas id="yearBuiltChart"></canvas>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h2>Property Sales Data</h2>
            <div class="card-icon">
                <i class="fas fa-home"></i>
            </div>
        </div>
        <div class="card-body">
            <div class="filter-section" id="filterSection">
                <button class="filter-toggle" id="toggleFilters">
                    <i class="fas fa-filter"></i> Show Filters
                </button>
                <div class="filter-wrapper" id="filterWrapper" style="display:none;">
                    <div class="filter-group row" id="filters"></div>
                    <div class="filter-actions">
                        <button class="btn-reset" id="resetFilters">Reset Filters</button>
                    </div>
                </div>
                <div class="d-flex justify-content-between align-items-center my-3">
                    <div id="entryCountInfo" class="text-secondary">Showing 0 entries</div>
                </div>
            </div>
            
            <div class="table-responsive">
                <table id="salesTable" class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Tax ID Number</th>
                            <th>Property Class</th>
                            <th>Property Address</th>
                            <th>Sale Date</th>
                            <th>Sale Price</th>
                            <th>SqFt</th>
                            <th>Price/SqFt</th>
                            <th>Price Time Adj</th>
                            <th>Price Adj/SqFt</th>
                            <th>Style</th>
                            <th>Year Built</th>
                            <th>Acreage</th>
                            <th>Bedrooms</th>
                            <th>Baths</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Toggle filter section
    $('#toggleFilters').on('click', function() {
        $('#filterWrapper').slideToggle(300);
        const icon = $(this).find('i');
        const text = $(this).text().trim();
        
        if (text === 'Show Filters') {
            $(this).html('<i class="fas fa-times"></i> Hide Filters');
        } else {
            $(this).html('<i class="fas fa-filter"></i> Show Filters');
        }
    });
    
    // Update statistics in footer
    function updateStats() {
        try {
            // If table isn't initialized yet, return early
            if (!$.fn.DataTable.isDataTable('#salesTable')) {
                return;
            }
            
            // Get the visible (filtered) rows
            const visibleRows = table.rows({search: 'applied'}).data();
            const totalVisibleRows = visibleRows.length;
            
            $('#rowCount').text(totalVisibleRows);
            
            let totalPrice = 0;
            let totalSqft = 0;
            let totalPricePerSqft = 0;
            
            // Only proceed if there are rows
            if (totalVisibleRows > 0) {
                // Process each visible row
                for (let i = 0; i < totalVisibleRows; i++) {
                    try {
                        const rowData = visibleRows[i];
                        
                        // Get the raw values from the cells
                        let priceRaw = rowData[4] || '0';
                        let sqftRaw = rowData[5] || '0';
                        let pricePerSqftRaw = rowData[6] || '0';
                        
                        // Clean the values - remove currency symbols and commas
                        if (typeof priceRaw === 'string') {
                            priceRaw = priceRaw.replace(/[$,]/g, '');
                        }
                        if (typeof sqftRaw === 'string') {
                            sqftRaw = sqftRaw.replace(/[,$]/g, '');
                        }
                        if (typeof pricePerSqftRaw === 'string') {
                            pricePerSqftRaw = pricePerSqftRaw.replace(/[$,]/g, '');
                        }
                        
                        // Parse values
                        const price = parseFloat(priceRaw) || 0;
                        const sqft = parseFloat(sqftRaw) || 0;
                        const pricePerSqft = parseFloat(pricePerSqftRaw) || 0;
                        
                        totalPrice += price;
                        totalSqft += sqft;
                        totalPricePerSqft += pricePerSqft;
                    } catch (e) {
                        console.warn("Error processing row for stats:", e);
                    }
                }
                
                // Calculate averages
                const avgPrice = totalPrice / totalVisibleRows;
                const avgSqft = totalSqft / totalVisibleRows;
                const avgPricePerSqft = totalPrice / totalSqft; // Calculate directly instead of averaging the per-row values
                
                $('#avgPrice').text('$' + avgPrice.toLocaleString('en-US', {maximumFractionDigits: 0}));
                $('#avgSqft').text(avgSqft.toLocaleString('en-US', {maximumFractionDigits: 0}));
                $('#avgPricePerSqft').text('$' + avgPricePerSqft.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
            } else {
                // No rows match the filter
                $('#avgPrice').text('$0');
                $('#avgSqft').text('0');
                $('#avgPricePerSqft').text('$0.00');
            }
        } catch (e) {
            console.error("Error updating stats:", e);
            $('#avgPrice').text('$0');
            $('#avgSqft').text('0');
            $('#avgPricePerSqft').text('$0.00');
        }
    }
    
    // Update entry count text
    function updateEntryCount() {
        try {
            // If table isn't initialized yet, return early
            if (!$.fn.DataTable.isDataTable('#salesTable')) {
                return;
            }
            
            const filteredRows = table.rows({search: 'applied'}).data().length;
            const totalRows = table.rows().data().length;
            $('#entryCountInfo').text(`Showing ${filteredRows} of ${totalRows} entries`);
        } catch (e) {
            console.error("Error updating entry count:", e);
            $('#entryCountInfo').text('Showing 0 entries');
        }
    }
    
    // Initialize DataTable with fewer visible columns
    const table = $('#salesTable').DataTable({
        dom: '<"d-flex justify-content-between align-items-center mb-3"<"d-flex align-items-center"l><"d-flex"f>>rtip',
        pageLength: 20,
        lengthMenu: [[10, 20, 50, 100, -1], [10, 20, 50, 100, "All"]],
        columns: [
            { title: "Tax ID Number" },
            { title: "Property Class" }, 
            { title: "Property Address", render: function(data) {
                if (!data) return '';
                
                // Create Google Maps link
                const addressForMaps = encodeURIComponent(data + ', East Greenbush, NY 12061');
                const mapUrl = `https://www.google.com/maps/search/?api=1&query=${addressForMaps}`;
                
                // Create PROS link using Tax ID
                const taxId = function(rowData) {
                    return rowData[0] || ''; // Tax ID is in the first column (index 0)
                };
                
                // Create icons with links - Note: Realtor icon now links to PROS
                const googleIcon = `<a href="${mapUrl}" target="_blank" class="map-icon" title="View on Google Maps"><i class="fas fa-map-marker-alt"></i></a>`;
                const prosIcon = `<a href="#" onclick="window.open('https://rensselaercounty.prosgar.com/PROSSearch/SearchIndex?SBL=' + this.closest('tr').cells[0].textContent, '_blank'); return false;" class="realtor-icon" title="View Property on PROS"><i class="fas fa-home"></i></a>`;
                
                return `${data} <span class="address-actions">${googleIcon} ${prosIcon}</span>`;
            }},
            { title: "Sale Date" }, 
            { title: "Sale Price", render: function(data) {
                const value = parseFloat(data);
                return '<span class="price-cell">$' + (isNaN(value) ? '0' : value.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0})) + '</span>';
            }}, 
            { title: "SqFt", render: function(data) {
                const value = parseFloat(data);
                return isNaN(value) ? '0' : value.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
            }},
            { title: "Price/SqFt", render: function(data) {
                const value = parseFloat(data);
                return isNaN(value) ? '$0.00' : '$' + value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            }}, 
            { title: "Price Time Adj", render: function(data) {
                const value = parseFloat(data);
                return isNaN(value) ? '$0' : '$' + value.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
            }},
            { title: "Price Adj/SqFt", render: function(data) {
                const value = parseFloat(data);
                return isNaN(value) ? '$0.00' : '$' + value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            }},
            { title: "Style" },
            { title: "Year Built" }, 
            { title: "Acreage" }, 
            { title: "Bedrooms" }, 
            { title: "Baths" }
        ],
        columnDefs: [
            { className: "text-center", targets: [5, 10, 11, 12, 13] },
            { width: "8%", targets: 0 },       // Tax ID Number
            { width: "6%", targets: 1 },       // Property Class
            { width: "15%", targets: 2 },      // Property Address
            { width: "7%", targets: 3 },       // Sale Date
            { width: "8%", targets: 4 },       // Sale Price
            { width: "6%", targets: 5 },       // SqFt
            { width: "7%", targets: 6 },       // Price/SqFt
            { width: "8%", targets: 7 },       // Price Time Adj
            { width: "8%", targets: 8 },       // Price Adj/SqFt
            { width: "8%", targets: 9 },       // Style
            { width: "6%", targets: 10 },      // Year Built
            { width: "5%", targets: 11 },      // Acreage
            { width: "4%", targets: 12 },      // Bedrooms
            { width: "4%", targets: 13 }       // Baths
        ],
        order: [[4, 'desc']], // Sort by sale price descending by default
        autoWidth: false,     // Disable auto width to use our custom widths
        scrollX: true,        // Enable horizontal scrolling if needed
        responsive: true,
        language: {
            lengthMenu: "Show _MENU_ entries",
            info: "Showing _START_ to _END_ of _TOTAL_ entries",
            infoEmpty: "Showing 0 to 0 of 0 entries",
            infoFiltered: "(filtered from _MAX_ total entries)"
        },
        drawCallback: function() {
            // Ensure headers have the correct styling applied after table draw
            $('#salesTable thead th').css({
                'background-color': '#4361ee',
                'color': 'white'
            });
            
            // Apply styling to the length menu dropdown
            $('.dataTables_length select').css({
                'padding': '6px',
                'border-radius': '5px',
                'border': '1px solid rgba(0,0,0,0.1)',
                'background-color': 'white',
                'margin': '0 5px'
            });
            
            // Now that the table is fully initialized, update stats and entry count
            setTimeout(function() {
                updateStats();
                updateEntryCount();
            }, 0);
        }
    });

    // Load CSV data
    function loadCSVData() {
        Papa.parse("https://labatt.github.io/sales_data.csv", {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                console.log('version 15'); // Increment each time there's a change
                
                const data = results.data.filter(row => row && row['Property Class']);
                
                const formattedData = data.map(row => {
                    try {
                        // Format the date properly if it exists
                        let formattedDate = row['Sale Date'] || '';
                        
                        // If we have a date, attempt to format it
                        if (formattedDate) {
                            try {
                                // Try to parse the date (handle various formats)
                                const dateParts = formattedDate.split('/');
                                if (dateParts.length === 3) {
                                    // Format is likely MM/DD/YYYY
                                    const month = dateParts[0].padStart(2, '0');
                                    const day = dateParts[1].padStart(2, '0');
                                    let year = dateParts[2];
                                    
                                    // Make sure year is 4 digits
                                    if (year.length === 2) {
                                        year = '20' + year; // Assume 20xx for 2-digit years
                                    }
                                    
                                    formattedDate = `${month}/${day}/${year}`;
                                }
                            } catch (e) {
                                console.warn("Error formatting date:", formattedDate, e);
                            }
                        }
                        
                        return [
                            row['Tax ID Number'] || '',
                            row['Property Class'] || '',
                            row['Property Address'] || '',
                            formattedDate,
                            row['Sale Price'] || '0',
                            row['SqFt'] || '0',
                            row['Sale Price per SqFt'] || '0',
                            row['Sale Price Time Adj'] || '0',
                            row['Sale Price Adj per SF'] || '0',
                            row['Style'] || '',
                            row['Year Built'] || '',
                            row['Acreage'] || '0',
                            row['Bedrooms'] || '0',
                            row['Baths'] || '0'
                        ];
                    } catch (e) {
                        console.error("Error processing row:", e, row);
                        return ['', '', '', '', '0', '0', '0', '0', '0', '', '', '0', '0', '0'];
                    }
                });

                table.rows.add(formattedData).draw();
                createFilters();
                updateStats();
                createCharts(data);
            },
            error: function(error) {
                console.error("Error loading CSV:", error);
                $('#salesTable tbody').html('<tr><td colspan="14" class="text-center">Error loading data</td></tr>');
            }
        });
    }

    // Create filter inputs
    function createFilters() {
        $('#filters').empty();
        
        // Define filters with correct column indexes
        const filterColumns = [
            { index: 1, name: 'Property Class', type: 'checkbox' },
            { index: 9, name: 'Style', type: 'checkbox' },
            { index: 12, name: 'Bedrooms', type: 'checkbox' },
            { index: 13, name: 'Baths', type: 'checkbox' }
        ];
        
        // Get unique values for each filter column
        const filterValues = {};
        filterColumns.forEach(column => {
            if (column.type === 'checkbox') {
                const uniqueValues = new Set();
                table.column(column.index).data().each(function(value) {
                    if (value && String(value).trim() !== '') {
                        uniqueValues.add(String(value).trim());
                    }
                });
                filterValues[column.name] = Array.from(uniqueValues).sort();
            }
        });
        
        // Create filter inputs based on type
        filterColumns.forEach(column => {
            const filterItem = $('<div class="filter-item"></div>').appendTo('#filters');
            $('<div class="filter-label">' + column.name + '</div>').appendTo(filterItem);
            
            if (column.type === 'checkbox') {
                // Create container for checkboxes
                const checkboxContainer = $('<div class="checkbox-container"></div>').appendTo(filterItem);
                
                // Add checkboxes from data
                filterValues[column.name].forEach(value => {
                    if (value) {
                        const checkboxId = 'chk-' + column.name.toLowerCase().replace(/\s+/g, '-') + '-' + value.replace(/\s+/g, '-').toLowerCase();
                        const checkboxItem = $('<div class="form-check"></div>').appendTo(checkboxContainer);
                        
                        const checkbox = $('<input class="form-check-input" type="checkbox" id="' + checkboxId + '" value="' + value + '">');
                        const label = $('<label class="form-check-label" for="' + checkboxId + '">' + value + '</label>');
                        
                        checkboxItem.append(checkbox).append(label);
                        
                        checkbox.on('change', function() {
                            // Get all checked values for this filter
                            const selectedValues = [];
                            checkboxContainer.find('input:checked').each(function() {
                                selectedValues.push($(this).val());
                            });
                            
                            if (selectedValues.length === 0) {
                                // If nothing selected, clear filter
                                table.column(column.index).search('').draw();
                            } else {
                                // Build regex for OR search
                                const regexPattern = selectedValues.map(val => '^' + $.fn.dataTable.util.escapeRegex(val) + '$').join('|');
                                table.column(column.index).search(regexPattern, true, false).draw();
                            }
                            updateStats();
                            updateEntryCount();
                        });
                    }
                });
                
                // Add Select All / Clear All buttons
                const controlsDiv = $('<div class="d-flex justify-content-between mt-1 select-controls"></div>').appendTo(filterItem);
                const selectAllBtn = $('<button class="btn btn-sm btn-outline-primary">Select All</button>').appendTo(controlsDiv);
                const clearBtn = $('<button class="btn btn-sm btn-outline-secondary">Clear</button>').appendTo(controlsDiv);
                
                selectAllBtn.on('click', function() {
                    checkboxContainer.find('input[type="checkbox"]').prop('checked', true).trigger('change');
                });
                
                clearBtn.on('click', function() {
                    checkboxContainer.find('input[type="checkbox"]').prop('checked', false).trigger('change');
                });
            }
        });
        
        // Add range filters in a single row
        const rangeFilterRow = $('<div class="filter-item"></div>').appendTo('#filters');
        $('<div class="filter-label">Range Filters</div>').appendTo(rangeFilterRow);
        
        // Container for all range filters
        const rangeContainer = $('<div class="d-flex flex-wrap gap-2"></div>').appendTo(rangeFilterRow);
        
        // Add Year Built range
        const yearBuiltGroup = $('<div class="range-group" style="flex: 1 1 auto;"></div>').appendTo(rangeContainer);
        $('<div class="filter-label">Year Built</div>').appendTo(yearBuiltGroup);
        const yearBuiltInputs = $('<div class="d-flex gap-2"></div>').appendTo(yearBuiltGroup);
        $('<input type="number" class="form-control filter-input" id="min-year-built" placeholder="Min">').appendTo(yearBuiltInputs);
        $('<input type="number" class="form-control filter-input" id="max-year-built" placeholder="Max">').appendTo(yearBuiltInputs);
        
        // Add SqFt range
        const sqftGroup = $('<div class="range-group" style="flex: 1 1 auto;"></div>').appendTo(rangeContainer);
        $('<div class="filter-label">SqFt</div>').appendTo(sqftGroup);
        const sqftInputs = $('<div class="d-flex gap-2"></div>').appendTo(sqftGroup);
        $('<input type="number" class="form-control filter-input" id="min-sqft" placeholder="Min">').appendTo(sqftInputs);
        $('<input type="number" class="form-control filter-input" id="max-sqft" placeholder="Max">').appendTo(sqftInputs);
        
        // Add Acreage range
        const acreageGroup = $('<div class="range-group" style="flex: 1 1 auto;"></div>').appendTo(rangeContainer);
        $('<div class="filter-label">Acreage</div>').appendTo(acreageGroup);
        const acreageInputs = $('<div class="d-flex gap-2"></div>').appendTo(acreageGroup);
        $('<input type="number" class="form-control filter-input" id="min-acreage" placeholder="Min" step="0.01">').appendTo(acreageInputs);
        $('<input type="number" class="form-control filter-input" id="max-acreage" placeholder="Max" step="0.01">').appendTo(acreageInputs);
        
        // Add Price range
        const priceGroup = $('<div class="range-group" style="flex: 1 1 auto;"></div>').appendTo(rangeContainer);
        $('<div class="filter-label">Price Range</div>').appendTo(priceGroup);
        const priceInputs = $('<div class="d-flex gap-2"></div>').appendTo(priceGroup);
        $('<input type="number" class="form-control filter-input" id="minPrice" placeholder="Min">').appendTo(priceInputs);
        $('<input type="number" class="form-control filter-input" id="maxPrice" placeholder="Max">').appendTo(priceInputs);
        
        // Apply range filters
        $('#min-year-built, #max-year-built').on('change', function() {
            applyRangeFilter(10, 'min-year-built', 'max-year-built');
        });
        
        $('#min-sqft, #max-sqft').on('change', function() {
            applyRangeFilter(5, 'min-sqft', 'max-sqft');
        });
        
        $('#min-acreage, #max-acreage').on('change', function() {
            applyRangeFilter(11, 'min-acreage', 'max-acreage');
        });
        
        $('#minPrice, #maxPrice').on('change', function() {
            applyRangeFilter(4, 'minPrice', 'maxPrice');
        });
        
        // Setup reset filters button
        setupResetFilters();
    }
    
    // Helper function for range filters
    function applyRangeFilter(columnIndex, minId, maxId) {
        const min = $('#' + minId).val();
        const max = $('#' + maxId).val();
        
        // Store filter settings for this column
        if (!table.settings()[0].customFilters) {
            table.settings()[0].customFilters = {};
        }
        
        // Update or clear this specific filter
        if (min === '' && max === '') {
            // If both empty, remove this filter
            delete table.settings()[0].customFilters[columnIndex];
        } else {
            // Store this filter's settings
            table.settings()[0].customFilters[columnIndex] = {
                min: min === '' ? -Infinity : parseFloat(min),
                max: max === '' ? Infinity : parseFloat(max)
            };
        }
        
        // Clear all current ext.search filters and add a single combined filter
        while ($.fn.dataTable.ext.search.length > 0) {
            $.fn.dataTable.ext.search.pop();
        }
        
        // Add a single filter that handles all range filters
        if (Object.keys(table.settings()[0].customFilters).length > 0) {
            $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
                // Only process our own settings
                if (settings.nTable.id !== 'salesTable') {
                    return true;
                }
                
                // Check all active filters
                for (const [colIdx, filterSettings] of Object.entries(settings.customFilters)) {
                    const colIndex = parseInt(colIdx, 10); // Ensure base-10 parsing
                    let value;
                    
                    try {
                        // Remove currency symbols and commas for proper parsing
                        let rawValue = data[colIndex] || '0';
                        if (typeof rawValue === 'string') {
                            rawValue = rawValue.replace(/[$,]/g, '');
                        }
                        value = parseFloat(rawValue) || 0;
                    } catch (e) {
                        console.warn(`Error parsing value for column ${colIndex}:`, e);
                        value = 0;
                    }
                    
                    // Check if this value is within range
                    if (value < filterSettings.min || value > filterSettings.max) {
                        return false; // This row doesn't match
                    }
                }
                
                // If we get here, all filters matched
                return true;
            });
        }
        
        table.draw();
        updateStats();
        updateEntryCount();
    }
    
    // Reset filters button
    function setupResetFilters() {
        $('#resetFilters').on('click', function() {
            // Clear all inputs
            $('.filter-input').val('');
            // Clear all checkboxes
            $('input[type="checkbox"]').prop('checked', false);
            // Reset the table search
            table.search('').columns().search('').draw();
            // Clear any custom filters
            while ($.fn.dataTable.ext.search.length > 0) {
                $.fn.dataTable.ext.search.pop();
            }
            // Clear custom filters memory
            if (table.settings()[0].customFilters) {
                table.settings()[0].customFilters = {};
            }
            // Update stats
            updateStats();
            updateEntryCount();
        });
    }

    // Create charts
    function createCharts(data) {
        // Group data by style
        const styleGroups = {};
        data.forEach(row => {
            if (!row || !row['Style']) return;
            
            const style = row['Style'];
            let price = 0;
            
            try {
                // Use the time-adjusted price if available
                if (row['Sale Price Time Adj']) {
                    price = parseFloat(row['Sale Price Time Adj']) || 0;
                } else if (row['Sale Price']) {
                    price = parseFloat(row['Sale Price']) || 0;
                }
            } catch (e) {
                console.warn("Error parsing price for chart:", e);
                price = 0;
            }
            
            if (!styleGroups[style]) {
                styleGroups[style] = [];
            }
            
            styleGroups[style].push(price);
        });
        
        // Calculate average price by style
        const styles = [];
        const avgPrices = [];
        const bgColors = [
            '#4361ee', '#3a0ca3', '#7209b7', '#f72585', '#4cc9f0', 
            '#4895ef', '#560bad', '#480ca8', '#b5179e', '#ff99c8'
        ];
        
        Object.keys(styleGroups).forEach((style, index) => {
            const prices = styleGroups[style];
            if (prices.length > 0) {
                const avgPrice = prices.reduce((a, b) => a + b, 0) / prices.length;
                styles.push(style);
                avgPrices.push(avgPrice);
            }
        });
        
        // Create style chart
        const styleCtx = document.getElementById('styleChart').getContext('2d');
        new Chart(styleCtx, {
            type: 'bar',
            data: {
                labels: styles,
                datasets: [{
                    label: 'Average Price ($)',
                    data: avgPrices,
                    backgroundColor: bgColors.slice(0, styles.length),
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Using Time-Adjusted Prices Where Available',
                        font: {
                            size: 12,
                            style: 'italic'
                        },
                        padding: {
                            bottom: 10
                        }
                    },
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return '$ ' + context.raw.toLocaleString('en-US', {maximumFractionDigits: 0});
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString('en-US', {
                                    notation: 'compact',
                                    compactDisplay: 'short'
                                });
                            }
                        }
                    }
                }
            }
        });
        
        // Group data by decade for year built chart
        const yearData = {};
        data.forEach(row => {
            if (!row || !row['Year Built']) return;
            
            try {
                const year = parseInt(row['Year Built']);
                if (!year || isNaN(year)) return;
                
                const decade = Math.floor(year / 10) * 10;
                let pricePerSqft = 0;
                
                // Try to use the adjusted price per sqft if available
                if (row['Sale Price Adj per SF']) {
                    pricePerSqft = parseFloat(row['Sale Price Adj per SF']) || 0;
                } else if (row['Sale Price per SqFt']) {
                    pricePerSqft = parseFloat(row['Sale Price per SqFt']) || 0;
                } else {
                    // Calculate manually as a last resort
                    const price = parseFloat(row['Sale Price']) || 0;
                    const sqft = parseFloat(row['SqFt']) || 1;
                    if (price > 0 && sqft > 0) {
                        pricePerSqft = price / sqft;
                    }
                }
                
                if (!yearData[decade]) {
                    yearData[decade] = [];
                }
                
                if (pricePerSqft > 0) {
                    yearData[decade].push(pricePerSqft);
                }
            } catch (e) {
                console.error("Error parsing year data:", e);
            }
        });
        
        // Calculate average price per sqft by decade
        const decades = [];
        const avgPricePerSqft = [];
        
        Object.keys(yearData).sort().forEach(decade => {
            const prices = yearData[decade];
            if (prices && prices.length > 0) {
                const avgPrice = prices.reduce((a, b) => a + b, 0) / prices.length;
                decades.push(decade + 's');
                avgPricePerSqft.push(avgPrice);
            }
        });
        
        // Create year built chart
        const yearCtx = document.getElementById('yearBuiltChart').getContext('2d');
        new Chart(yearCtx, {
            type: 'line',
            data: {
                labels: decades,
                datasets: [{
                    label: 'Avg Price per SqFt ($)',
                    data: avgPricePerSqft,
                    borderColor: '#4361ee',
                    backgroundColor: 'rgba(67, 97, 238, 0.1)',
                    borderWidth: 3,
                    pointBackgroundColor: '#7209b7',
                    pointRadius: 5,
                    fill: true,
                    tension: 0.2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Using Time-Adjusted Prices Where Available',
                        position: 'bottom',
                        font: {
                            size: 12,
                            style: 'italic'
                        },
                        padding: {
                            top: 10
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return '$ ' + context.raw.toFixed(2);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toFixed(0);
                            }
                        }
                    }
                }
            }
        });
    }

    loadCSVData();
    
    // Listen for DataTable page change events
    $('#salesTable').on('page.dt', function() {
        updateStats();
        updateEntryCount();
    });
    
    // Listen for length (entries per page) change
    $('#salesTable').on('length.dt', function() {
        updateStats();
        updateEntryCount();
    });
});
</script>
</body>
</html>